Massive code refactoring to get ready for the mobile app.
