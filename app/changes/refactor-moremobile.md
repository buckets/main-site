More internal refactoring to prepare for mobile apps
