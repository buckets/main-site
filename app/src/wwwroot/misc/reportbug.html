<!DOCTYPE html>
<html>
<head>
  <title data-translate>Report Bug</title>
  <link rel="stylesheet" type="text/css" href="../assets/fonts.css" />
  <link rel="stylesheet" type="text/css" href="../assets/style.css" />
  <link rel="stylesheet" type="text/css" href="../assets/fontawesome/css/font-awesome.min.css" />
  <link rel="stylesheet" type="text/css" href="../assets/singlepane.css" />
  <style type="text/css">
    textarea {
      width: 100%;
      height: 5rem;
    }
    .attachment-previews {
      overflow-x: auto;
      display: flex;
    }
    .attachment-previews img {
      max-height: 3rem;
      border: .25rem solid white;
    }
    .attachment-previews img:hover{
      opacity: 0.5;
      border-color: red;
    }
    .error {
      padding-bottom: .5rem;
    }
    .hide {
      display: none;
    }
    .dropzone {
      opacity: 0.3;
    }
    .aside {
      opacity: 0.6;
      font-size: 75%;
    }
  </style>
  <style type="text/css">
  </style>
</head>
<body class="singlepane">
  <div class="singlepane-handle"></div>
  <div class="singlepane-guts scrollinner">
    <div class="padded">
      <div>
        <b data-translate>Your email address:</b> <div data-translate class="aside">(If you want a response)</div>
        <div><input autofocus type="email" id="from_email" style="width: 100%"></div>
      </div>
      <div>
        <b data-translate>Optional message:</b>
        <div><textarea id="message"></textarea></div>
      </div>
      <div>
        <label><input type="checkbox" checked id="include_log" /> <span data-translate>Include log file</span></label>
      </div>
      <br/>
      <div>
        <b data-translate>Screenshots:</b> <div><span class="aside" data-translate>(Drop files or click)</span> <input type="file" id="upload-button" accept="image/*"></div> 
      </div>
      <div id="attachment-previews" class="attachment-previews"></div>
      <p data-translate>
        Though filling out this form is preferrable, you can also email bugs@budgetwithbuckets.com
      </p>
      <div class="error" id="error-message">
        <div id="error-files-too-big" class="hide" data-translate>Attached files are too large.</div>
      </div>
      <div style="text-align: start;">
        <button class="primary" id="button" type="submit" data-translate>Send Report</button>
      </div>
    </div>
  </div>
<script>
const {remote} = require('electron');
const Path = require('path');
const appPath = remote.app.getAppPath();
const req = function() {
  return (module) => {
    if (module.startsWith('.') || module.startsWith('/')) {
      return require(Path.resolve(appPath, module))
    } else {
      return require(module);
    }
  }
}();
req('./src/wwwroot/misc/singlepane.js');
const log = require('electron-log')
const fs = require('fs-extra-promise')
const { submitFeedback } = req('./src/errors.js');

const { localizeThisPage } = req('./src/i18n');
const querystring = req('querystring');
localizeThisPage();
let qs = querystring.parse(window.location.search.substr(1));

const theform = document.getElementById('theform');
const email_el = document.getElementById('from_email');
const message_el = document.getElementById('message');
const log_el = document.getElementById('include_log');
const button = document.getElementById('button');
const upload_button = document.getElementById('upload-button');
const previews = document.getElementById('attachment-previews');
const error_el = document.getElementById('error-message');

const MAX_EXTRA_ATTACHMENTS_SIZE = 4.5 * 1024 * 1024;
let extra_attachments = [];

email_el.value = qs.email || '';
message_el.value = qs.template;
const logfile_path = qs.logfile_path;

if (qs.email) {
  message_el.focus();
}

upload_button.addEventListener('change', (ev) => {
  const curFiles = upload_button.files;
  if (curFiles.length !== 0) {
    addAttachments(curFiles);
  }
  upload_button.value = null;
})

button.addEventListener('click', () => {
  let attachments = [...extra_attachments];
  let p;
  if (log_el.checked) {
    p = new Promise((resolve, reject) => {
      fs.readFile(logfile_path, (err, data) => {
        if (err) {
          reject(err);
        } else {
          attachments.push({
            Name: "buckets.log",
            Content: new Buffer(data).toString('base64'),
            ContentType: 'text/plain',
          })
          resolve(null);
        }
      });
    });
  } else {
    p = Promise.resolve(null);
  }
  p.then(() => {
    let data = {
      from_email: email_el.value || '',
      body: `${message_el.value}\n\n---\n\n${qs.nittygritty}`,
      attachments,
    }
    log.silly('submitting bug report', data.from_email, data.body);
    submitFeedback(data)
    .then(() => {
      remote.getCurrentWindow().close();  
    })
    .catch(() => {
      remote.getCurrentWindow().hide();
    });
    remote.getCurrentWindow().hide();
  })
})

function addAttachments(filelist) {
  for (let file of filelist) {
    if (!file.type.startsWith('image/')) {
      // skip this file type
      continue;
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
      extra_attachments.push({
        Name: file.name,
        Content: Buffer.from(ev.target.result).toString('base64'),
        ContentType: file.type,
      })
      updatePreviews();
    }
    reader.readAsArrayBuffer(file);
  }
}

function updatePreviews() {
  maybeWarnOnSize();
  let elements = extra_attachments.map((attachment, i) => {
    let img = document.createElement('img');
    img.src = `data:${attachment.ContentType};base64,${attachment.Content}`;
    img.addEventListener('click', ev => {
      extra_attachments.splice(i, 1);
      updatePreviews();
    });
    return img;
  });
  previews.innerHTML = '';
  elements.forEach(elem => {
    previews.appendChild(elem);
  })
}

function maybeWarnOnSize() {
  let total_file_size = 0;
  let err_el = document.getElementById('error-files-too-big')
  extra_attachments.forEach(attachment => {
    total_file_size += attachment.Content.length;
  });
  if (total_file_size > MAX_EXTRA_ATTACHMENTS_SIZE) {
    err_el.classList.remove('hide');
  } else {
    err_el.classList.add('hide');
  }
}

document.body.addEventListener('dragover', ev => {
  ev.preventDefault();
  ev.dataTransfer.dropEffect = 'copy';
  document.body.classList.add('dropzone');
})
document.body.addEventListener('dragleave', ev => {
  document.body.classList.remove('dropzone');
})
document.body.addEventListener('drop', ev => {
  document.body.classList.remove('dropzone');
  ev.preventDefault();
  addAttachments(ev.dataTransfer.files);
})

</script>
</body>
</html>