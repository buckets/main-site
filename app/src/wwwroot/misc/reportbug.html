<!DOCTYPE html>
<html>
<head>
  <title data-translate>Report Bug</title>
  <link rel="stylesheet" type="text/css" href="../assets/fonts.css" />
  <link rel="stylesheet" type="text/css" href="../assets/style.css" />
  <link rel="stylesheet" type="text/css" href="../assets/fontawesome/css/font-awesome.min.css" />
  <link rel="stylesheet" type="text/css" href="../assets/singlepane.css" />
  <style type="text/css">
    textarea {
      width: 100%;
      height: 5rem;
    }
  </style>
  <style type="text/css">
  </style>
</head>
<body class="singlepane">
  <div class="singlepane-handle"></div>
  <div class="singlepane-guts scrollinner">
    <div class="padded">
      <div>
        <b data-translate>Your email address:</b> <input autofocus type="email" id="from_email">
      </div>
      <div>
        <b data-translate>Message:</b>
        <div><textarea id="message"></textarea></div>
      </div>
      <div>
        <b data-translate>Other details:</b>
        <div><textarea id="details" disabled></textarea></div>
      </div>
      <div>
        <label><input type="checkbox" checked id="include_log" /> <span data-translate>Include log file</span></label>
      </div>
      <br/>
      <div>
        <button id="button" type="submit" data-translate>Send Report</button>
      </div>
      <br/>
      <p data-translate>
        If you wish to provide screenshots or other information, email bugs@budgetwithbuckets.com
      </p>
    </div>
  </div>
  <div id="singlepane-close"></div>
<script>
const {remote} = require('electron');
const Path = require('path');
const appPath = remote.app.getAppPath();
const req = function() {
  return (module) => {
    if (module.startsWith('.') || module.startsWith('/')) {
      return require(Path.resolve(appPath, module))
    } else {
      return require(module);
    }
  }
}();
req('./src/wwwroot/misc/singlepane.js');
const log = require('electron-log')
const fs = require('fs-extra-promise')
const { submitBugReport } = req('./src/errors.js');

const { localizeThisPage } = req('./src/i18n');
const querystring = req('querystring');
localizeThisPage();
let qs = querystring.parse(window.location.search.substr(1));

const theform = document.getElementById('theform');
const email_el = document.getElementById('from_email');
const message_el = document.getElementById('message');
const details_el = document.getElementById('details');
const log_el = document.getElementById('include_log');
const button = document.getElementById('button');

email_el.value = qs.email || '';
message_el.value = qs.template;
details_el.value = qs.nittygritty;
const logfile_path = qs.logfile_path;

if (qs.email) {
  message_el.focus();
}

button.addEventListener('click', () => {
  let attachments = [];
  let p;
  if (log_el.checked) {
    p = new Promise((resolve, reject) => {
      fs.readFile(logfile_path, (err, data) => {
        if (err) {
          reject(err);
        } else {
          attachments.push({
            Name: "buckets.log",
            Content: new Buffer(data).toString('base64'),
            ContentType: 'text/plain',
          })
          resolve(null);
        }
      });
    });
  } else {
    p = Promise.resolve(null);
  }
  p.then(() => {
    let data = {
      from_email: email_el.value || '',
      body: `${message_el.value}\n\n---\n\n${qs.nittygritty}`,
      attachments,
    }
    log.silly('submitting bug report', data.from_email, data.body);
    submitBugReport(data)
    .then(() => {
      remote.getCurrentWindow().close();  
    })
    .catch(() => {
      remote.getCurrentWindow().hide();
    });
    remote.getCurrentWindow().hide();
  })
})


</script>
</body>
</html>