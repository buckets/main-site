<!DOCTYPE html>
<html>
<head>
  <title>Enter Buckets License</title>
  <link rel="stylesheet" type="text/css" href="../assets/fonts.css" />
  <link rel="stylesheet" type="text/css" href="../assets/style.css" />
  <link rel="stylesheet" type="text/css" href="../assets/fontawesome/css/font-awesome.min.css" />
  <style type="text/css">
    html {
      height: 100%;
    }
  </style>
  <style type="text/css">
  .license {
    padding: 1rem;
  }
  button {
    margin-left: 0;
    margin-right: 0;
  }
  .textareaholder {
    width: 100%;
  }
  textarea {
    box-sizing: border-box;
    font-family: monospace;
    padding: 1rem;
    margin: 0 auto;
    box-shadow: inset 0 0 7px -2px var(--grey);
    border: 1px solid var(--lighter-grey);
    border-radius: 3px;
    background-color: var(--lightest-grey);
    font-size: 1rem;
    text-align: left;
    color: black;
  }
  #status {
    color: var(--blue);
    padding: 0 0 1rem;
  }
  #status.error {
    color: var(--red);
  }
  </style>
</head>
<body>
  <div class="license">
    <p>
      Please enter your Buckets License below.  Don't have a license?  <a href="#" id="clicktobuy">Click here to purchase one.</a>
    </p>
    <div class="textareaholder">
      <textarea id="license-input" cols="43" rows="10" placeholder="------------- START LICENSE ---------------xxxxxxxxxx xxxxxxxxxx xxxxxxxxxx xxxxxxxxxx   xxxxxxxxxx xxxxxxxxxx xxxxxxxxxx xxxxxxxxxx  ------------- END LICENSE -----------------"></textarea>
    </div>
    <p>
      <div id="status">&nbsp;</div>
      <button id="submit-button">Submit</button>
    </p>
  </div>
<script>
const app = require('electron').remote.app;
const path = require('path');
const {enterLicense, openBuyPage} = require(path.resolve('./src/mainprocess/drm.js'));
const log = require('electron-log');
let state = 'init';
let textarea_box = document.getElementById('license-input');
let button = document.getElementById('submit-button');
let status_div = document.getElementById('status');
let clicktobuy = document.getElementById('clicktobuy');
clicktobuy.addEventListener('click', (ev) => {
  openBuyPage();
  ev.preventDefault();
  return false;
}, false)
button.addEventListener('click', () => {
  if (state === 'init') {
    status_div.innerHTML = '&nbsp;';
    status_div.classList.remove('error');
    try {
      enterLicense(textarea_box.value);
      state = 'success';
      status_div.innerHTML = 'Success!';
      button.innerHTML = 'Restart Buckets';
    } catch(err) {
      log.error(`Error entering license: ${err}`);
      status_div.innerHTML = 'Invalid license';
      status_div.classList.add('error');
    }
  } else if (state === 'success') {
    app.relaunch();
    app.quit();
  }
}, false);
</script>
</body>
</html>