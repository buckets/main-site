{% extends 'farm/base.html' %}

{% block content %}

<h1>Buckets</h1>

<script type="text/babel">
var target_el = thisNext();

var Store = {};
Store.buckets = {{ buckets|tojson|safe }};
Store.rerender = function() {
  ReactDOM.render(<BucketTable buckets={Store.buckets}/>, target_el);
}
Store.updateBucket = function(bucket) {
  _.each(Store.buckets, function(old_bucket) {
    if (old_bucket.id === bucket.id) {
      _.merge(old_bucket, bucket);
    }
  });
  Store.rerender();
}


var Money = React.createClass({
  render: function() {
    var value = cents2decimal(this.props.value);
    return (<span className="number">{value}</span>)
  }
});


var BucketRow = React.createClass({
  getInitialState: function() {
    return {
      pending_amount: '',
    }
  },
  refreshBucket: function() {
    this.props.onBucketDirty(this.props.bucket);
  },
  pendingKeyUp: function(e) {
    if (e.keyCode === 13) {
      this.doTransaction();
    }
  },
  pendingChanged: function(e) {
    this.setPending(e.target.value);
  },
  setPending: function(value) {
    this.setState({
      pending_amount: value
    })
    this.props.onPendingChange(this.props.bucket,
      decimal2cents(value));
  },
  doTransaction: function() {
    var amount = decimal2cents(this.state.pending_amount);
    this.setPending('');
    apiRequest({
      method: 'bucket_transact',
      kwargs: {
        bucket_id: this.props.bucket.id,
        amount: amount,
      }
    }, function(response) {
      this.refreshBucket();
    }.bind(this));
  },
  render: function() {
    return (
      <tr>
        <td>{this.props.bucket.name}</td>
        <td className="right"><Money value={this.props.bucket.balance} /></td>
        <td className="right">
          <input
          type="text" 
          className="right"
          value={this.state.pending_amount}
          onKeyUp={this.pendingKeyUp}
          onChange={this.pendingChanged}/>
        </td>
        <td><Money value={this.props.bucket.deposit} /></td>
        <td></td>
        <td><a href={'buckets/'+this.props.bucket.id}>Edit</a></td>
      </tr>
    )
  }
});



var BucketTable = React.createClass({
  getInitialState: function() {
    return {
      pendings: {}
    }
  },
  pendingChanged: function(bucket, pending) {
    this.state.pendings[bucket.id] = pending;
    this.setState(this.state);
  },
  bucketIsDirty: function(bucket) {
    apiRequest({
      method: 'get_bucket',
      kwargs: {
        id: bucket.id,
      }
    }, function(new_bucket) {
      Store.updateBucket(new_bucket);
    })
  },
  render: function() {
    var balance_total = 0;
    var bucket_rows = this.props.buckets.map(function(bucket) {
      balance_total += bucket.balance;
      return (
        <BucketRow key={bucket.id} bucket={bucket} onPendingChange={this.pendingChanged} onBucketDirty={this.bucketIsDirty}></BucketRow>
      );
    }.bind(this));
    var pending_total = _.sum(_.values(this.state.pendings));
    return (
      <table className="ledger" width="100%">
        <thead>
          <tr>
            <th>Bucket</th>
            <th className="right">Balance</th>
            <th className="right">Deposit</th>
            <th>Monthly<br/>Deposit</th>
            <th>Goal</th>
            <th>Edit</th>
          </tr>
        </thead>
        <tbody>
          {bucket_rows}
        </tbody>
        <tbody>
          <tr className="subtotal">
            <td>Total</td>
            <td className="right"><Money value={balance_total} /></td>
            <td className="right">
              <Money value={pending_total} />
            </td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    );
  }
});
Store.rerender();
</script>

<h2>Add bucket</h2>
<form method="post">
<table class="form">
  <tr>
    <th>Name</th>
    <td><input type="text" name="name"></td>
  </tr>
  <tr>
    <th></th>
    <td><button type="submit">Add Bucket</button></td>
  </tr>
</table>
</form>
{% endblock %}