{% extends 'farm/base.html' %}

{% block content %}

<h1>Transactions</h1>

<script type="text/babel">
var target_el = thisNext();

var Store = {};
Store.transactions = [];
Store.buckets = {{ buckets|json|safe }};
Store.accounts = {{ accounts|json|safe }};
Store.rerender = function() {
  ReactDOM.render(<TransTable buckets={Store.buckets} transactions={Store.transactions} accounts={Store.accounts} />, target_el);
}
Store.addTransaction = function(trans) {
  Store.transactions.push(trans);
  Store.rerender();
}

var TransRow = React.createClass({
  render: function() {
    var account = _.find(this.props.accounts, function(account) {
      return account.id === this.props.transaction.account_id;
    }.bind(this));
    return (
      <tr>
        <td><input type="checkbox" /></td>
        <td>{this.props.transaction.posted.split('T')[0]}</td>
        <td>{account.name}</td>
        <td>{this.props.transaction.memo}</td>
        <td><Money value={this.props.transaction.amount} /></td>
        <td></td>
      </tr>
    )
  }
})

var TransTable = React.createClass({
  getInitialState: function() {
    var today = (new Date()).toISOString().split('T')[0];
    return {
      amount: '',
      posted: today,
      memo: '',
      account_id: '',
    }
  },
  componentDidMount: function() {
    apiRequest({
      method: 'list_account_trans',
    }, function(response) {
      Store.transactions = response;
      Store.rerender();
    }.bind(this));
  },
  createTransaction: function() {
    if (!this.state.account_id || !this.state.posted || !this.state.amount) {
      return;
    }
    apiRequest({
      method: 'account_transact',
      kwargs: {
        account_id: this.state.account_id,
        posted: this.state.posted,
        memo: this.state.memo,
        amount: this.state.amount,
      }
    }, function(response) {
      Store.addTransaction(response);
    }.bind(this));

    this.setState({
      amount: '',
      memo: '',
    });
    this._descriptionInput.focus();
  },
  propLink: function(attr) {
    return {
      value: this.state[attr],
      onChange: this.valueChangeHandler(attr),
    }
  },
  valueChangeHandler: function(attr) {
    return function(ev) {
      var newstate = {};
      newstate[attr] = ev.target.value;
      this.setState(newstate);
    }.bind(this);
  },
  amountChanged: function(amount) {
    this.setState({amount: amount});
  },
  descriptionRef: function(input) {
    this._descriptionInput = input;
  },
  render: function() {
    var transaction_rows = [];
    transaction_rows = _.sortBy(this.props.transactions, ['posted', 'id'])
      .map(function(trans) {
        return (<TransRow key={trans.id} transaction={trans} accounts={this.props.accounts} />);
    }.bind(this));
    var add_label = this.state.amount < 0 ? 'Record expense' : 'Record deposit';
    var account_options = this.props.accounts.map(function(account) {
      return (<option key={account.id} value={account.id}>{account.name}</option>);
    })
    return (
    <table className="ledger" width="100%">
      <thead>
        <tr>
          <th><input type="checkbox" /></th>
          <th>Date</th>
          <th>Account</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Buckets</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td></td>
          <td><input type="date" {...this.propLink('posted')} /></td>
          <td><select {...this.propLink('account_id')}>
            <option value=""></option>{account_options}</select></td>
          <td><input ref={this.descriptionRef} type="text" {...this.propLink('memo')} /></td>
          <td><MoneyInput value={this.state.amount} onChange={this.amountChanged} /></td>
          <td><button onClick={this.createTransaction}>{add_label}</button></td>
        </tr>
        {transaction_rows}
      </tbody>
    </table>
    )  
  }
});
Store.rerender();
</script>


{% endblock %}